export SD_CURL_ALLOW_VERSION=072901
export SD_CURL_VERSION=$(curl -V | head -1 | awk '{print $2}' | awk -F. '{printf "%02d%02d%02d", $1, $2, $3}')
export SD_CURL_CMD_WRAPPER=$(if test $SD_CURL_VERSION -ge $SD_CURL_ALLOW_VERSION; then echo 'eval'; else echo 'sd-step exec core/curl'; fi)
cd $SD_ARTIFACTS_DIR
find . -type f -print > manifest.txt
find . -type f -exec sh -c 'f=`echo $1 | sed "s/^\.\///"`; encoded=$($SD_CURL_CMD_WRAPPER "curl -s -w \"%{url_effective}\" --data-urlencode $f -G \"\" | sed -e \"s/^\/?//\""); $($SD_CURL_CMD_WRAPPER "curl -H \"Authorization: Bearer $SD_TOKEN\" -H \"Content-Type: text/plain\" -X PUT $STORE_URL/v1/builds/$SD_BUILD_ID/$ARTIFACTS_DIR_SUFFIX/$encoded -T ./$f")' -- {} \;
